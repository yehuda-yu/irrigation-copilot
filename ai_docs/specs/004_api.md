# API Specification

The Irrigation Copilot API provides endpoints for deterministic irrigation planning and AI-powered agent orchestration.

## Base URL
Default: `http://127.0.0.1:8000`

## Authentication
Authentication is optional but can be enabled by setting `API_AUTH_KEY` in the environment.
If enabled, include the following header:
`X-API-Key: your_api_auth_key`

## Endpoints

### 1. Deterministic Irrigation Planning
**POST** `/irrigation/plan`

Generates a deterministic irrigation plan based on location and plant/crop information. No LLM is involved.

#### Request Body
```json
{
  "lat": 32.0853,
  "lon": 34.7818,
  "date": "2025-12-27",
  "mode": "farm",
  "crop_name": "tomato",
  "stage": "mid",
  "area_dunam": 5.0,
  "offline": false
}
```
- `lat`, `lon` (float): Required.
- `mode` (string): "farm" or "plant". Required.
- `date` (string): Optional (YYYY-MM-DD). Defaults to today.
- `offline` (boolean): Optional. If true, only uses cached forecast data.
- **Farm Mode Fields**: `crop_name` (req), `area_dunam` (req), `stage` ("initial", "mid", "late"), `irrigation_method`, `efficiency`.
- **Plant Mode Fields**: `plant_profile` (req), `pot_diameter_cm`, `pot_volume_l` (one of these req).

#### Example Call
```bash
curl -X POST http://127.0.0.1:8000/irrigation/plan \
  -H "Content-Type: application/json" \
  -d '{
    "lat": 32.0853,
    "lon": 34.7818,
    "mode": "farm",
    "crop_name": "tomato",
    "area_dunam": 5
  }'
```

---

### 2. AI Agent Orchestration
**POST** `/agent/run`

Runs the AI agent to process a natural language irrigation query.

#### Request Body
```json
{
  "message": "I have a small tomato farm at 32.08, 34.78. What is the plan for today?",
  "offline": false
}
```
- `message` (string): Natural language query. Required.
- `offline` (boolean): Optional.

#### Example Call
```bash
curl -X POST http://127.0.0.1:8000/agent/run \
  -H "Content-Type: application/json" \
  -d '{
    "message": "lat=32.0853 lon=34.7818 mode=farm crop_name=tomato area_dunam=5. Compute today plan."
  }'
```

## Error Handling
All errors return a consistent format:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message",
    "details": {}
  }
}
```
Common codes:
- `VALIDATION_ERROR` (422/400)
- `UNKNOWN_CROP` (400)
- `OFFLINE_CACHE_MISS` (503)
- `RATE_LIMIT_EXCEEDED` (429)
- `INTERNAL_SERVER_ERROR` (500)

## Rate Limiting
The `/agent/run` endpoint has a simple in-memory rate limit (default 10 requests per minute).

